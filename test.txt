#include <stdio.h>
#include <stdlib.h>
#include <limits.h>
#include <sys/ioctl.h>
#include <unistd.h>

#define MAX_ARRAY_LENGTH 10000

struct array_static
{
    int length;
    int values[MAX_ARRAY_LENGTH];
};

/**
 * @returns the max value of the array in a struct
 */
int max_arr_struct(struct array_static *arr) {
    int max = arr->values[0];
    for(size_t i = 1; i < arr->length; i++) {
        if(max < arr->values[i]) {
            max = arr->values[i];
        }
    }
    return max;
}

/**
 * @returns a histogram of an array
 */
void print_hist1(int *arr, int arr_length) {
    int max = arr[0];
    for(size_t i = 1; i < arr_length; i++) {
        if(max < arr[i]) {
            max = arr[i];
        }
    }
    for(int zeile = 1; zeile <= max; zeile++) {
        for(int spalte = 0; spalte < arr_length; spalte++) {
            if(arr[spalte] >= max-zeile+1) {
                printf("#");
            }
            else {
                printf(" ");
            }
        }
        printf("\n");
    }
}

void print_hist2(struct array_static *arr) {
    int max = arr->values[0];
    for(size_t i = 1; i < arr->length; i++) {
        if(max < arr->values[i]) {
            max = arr->values[i];
        }
    }
    for(int zeile = 1; zeile <= max; zeile++) {
        for(int spalte = 0; spalte < arr->length; spalte++) {
            if(arr->values[spalte] >= max - zeile + 1) {
                printf("#");
            }
            else {
                printf(" ");
            }
        }
        printf("\n");
    }
}

//Methode für großes Histogramm ausgeben
void print_hist_large(struct array_static *arr, int maxE, struct winsize *w) {
    if(arr->length > w->ws_col) {
        for(int move = 0; move <= arr->length - w->ws_col; move++) {
            for (int zeile = 0; zeile < maxE; zeile++) {
                for (int spalte = 0; spalte < w->ws_col; spalte++) {
                    if (arr->values[spalte + move] >= (maxE - zeile)) {
                        printf("#");
                    }
                    else {
                        printf(" ");
                    }
                }
                printf("\n");
            }
            if(move == arr->length - w->ws_col) {
                usleep(3000*1000); //3s warten bis Histogramm gelöscht wird
            }
            usleep(500*1000); //500ms warten
            system("clear"); //Konsole löschen
        }
    }
    else {
        for (int zeile = 0; zeile < maxE; zeile++) {
            for (int spalte = 0; spalte < arr->length; spalte++) {
                if (arr->values[spalte] >= (maxE - zeile)) {
                    printf("#");
                }
                else {
                    printf(" ");
                }
            }
            printf("\n");
        }
    }
}

int get_terminal_dim(struct winsize *w){
    // Get terminal window size
    if (ioctl(STDOUT_FILENO, TIOCGWINSZ, w) == -1) {
        perror("ioctl");
        return 1;
    }
    //printf("Terminal width: %d columns\n", w->ws_col);
    //printf("Terminal height: %d rows\n", w->ws_row);
    return 0;
}

int main(int argc, char * argv[]) {
    struct winsize w;
    get_terminal_dim(&w); //Terminal window size
    
    // 1. Aufgabe: Histogramm aus array
    /* int hist[] = {1,2,3,4,5,6,7,8,9,2,6,8,9,1,3,8,12,3};
    int hist_length = sizeof(hist) / sizeof(hist[0]);
    print_hist1(hist, hist_length); */


    // 2. Aufgabe: Histogramm aus struct(length, array)
    /* struct array_static hist2 ={18, {9,2,3,4,5,6,7,8,3,2,6,8,9,1,3,8,12,3}};
    print_hist2(&hist2); */

    struct array_static hist_s = {160, {
        3, 7, 1, 9, 4, 2, 8, 6, 5, 3,
        12, 4, 7, 9, 1, 3, 8, 5, 6, 2,
        11, 3, 5, 7, 9, 2, 4, 10, 6, 8,
        1, 12, 4, 9, 3, 7, 5, 8, 6, 2,
        10, 3, 7, 11, 4, 1, 6, 9, 8, 5,
        2, 12, 3, 7, 10, 4, 6, 1, 9, 8,
        5, 11, 3, 7, 2, 10, 4, 6, 9, 1,
        8, 12, 5, 3, 7, 9, 2, 10, 6, 4,
        11, 1, 8, 5, 3, 12, 7, 4, 9, 10,
        2, 6, 11, 8, 5, 3, 1, 7, 10, 4,
        9, 12, 6, 2, 8, 5, 3, 11, 7, 4,
        10, 1, 9, 6, 12, 5, 3, 8, 7, 4,
        2, 10, 11, 9, 6, 12, 5, 3, 8, 7,
        4, 1, 10, 11, 2, 6, 9, 12, 5, 3,
        7, 4, 8, 10, 1, 11, 6, 9, 5, 12,
        1, 2, 3, 4, 5, 6, 7, 8, 9, 10
        } };

    int max_hist_s = max_arr_struct(&hist_s);
    print_hist_large(&hist_s, max_hist_s, &w); //Methode für großes Histogramm

    return 0;
}